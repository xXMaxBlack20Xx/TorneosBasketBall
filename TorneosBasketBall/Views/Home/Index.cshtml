@model TorneosBasketBall.Models.DashboardViewModel
@{
    Layout = "_Layout";
    ViewData["Title"] = "Tablero General del Torneo";

    //Equipos
    int page = ViewBag.CurrentPage;
    int totalPages = ViewBag.TotalPages;
    int selectedEquipo = ViewBag.EquipoSeleccionado ?? 0;
    var pagedEquipos = Model.Equipos;

    //Jugadores
    const int playersPageSize = 5;
    var jugPageQuery = ViewContext.HttpContext.Request.Query["jugPage"].ToString();
    int jugPage = 1;
    if (!string.IsNullOrEmpty(jugPageQuery) && int.TryParse(jugPageQuery, out var jp))
    {
        jugPage = jp;
    }
    int totalJugadores = Model.Jugadores.Count;
    int totalJugPages = (int)Math.Ceiling(totalJugadores / (double)playersPageSize);
    var pagedJugadores = Model.Jugadores
        .Skip((jugPage - 1) * playersPageSize)
        .Take(playersPageSize)
        .ToList();

    //Partidos
    const int matchesPageSize = 5;
    var partidoPageQuery = ViewContext.HttpContext.Request.Query["partidoPage"].ToString();
    int partidoPage = 1;
    if (!string.IsNullOrEmpty(partidoPageQuery) && int.TryParse(partidoPageQuery, out var pp))
    {
        partidoPage = pp;
    }
    int totalPartidos = Model.Partidos.Count;
    int totalPartPages = (int)Math.Ceiling(totalPartidos / (double)matchesPageSize);
    var pagedPartidos = Model.Partidos
        .Skip((partidoPage - 1) * matchesPageSize)
        .Take(matchesPageSize)
        .ToList();

    //Estadisticas
    const int statsPageSize = 5;
    var statsPageQuery = ViewContext.HttpContext.Request.Query["statsPage"].ToString();
    int statsPage = 1;
    if (!string.IsNullOrEmpty(statsPageQuery) && int.TryParse(statsPageQuery, out var sp))
    {
        statsPage = sp;
    }
    int totalStats = Model.Estadisticas.Count;
    int totalStatsPages = (int)Math.Ceiling(totalStats / (double)statsPageSize);
    var pagedStats = Model.Estadisticas
        .Skip((statsPage - 1) * statsPageSize)
        .Take(statsPageSize)
        .ToList();
}

<h2 class="mb-4">Tablero General del Torneo</h2>

<form method="get" class="mb-4">
    <div class="row g-2 align-items-end">
        <div class="col-md-4">
            <label for="equipoId" class="form-label">Filtrar por equipo:</label>
            <select id="equipoId" name="equipoId" class="form-select">
                @* “Todos los equipos” *@
                @if (selectedEquipo == 0)
                {
                    <option value="0" selected="selected">Todos los equipos</option>
                }
                else
                {
                    <option value="0">Todos los equipos</option>
                }

                @* Ahora sí recorremos todos los equipos *@
                @foreach (var eq in Model.AllEquipos)
                {
                    if (eq.EquipoID == selectedEquipo)
                    {
                        <option value="@eq.EquipoID" selected="selected">
                            @eq.NombreEquipo
                        </option>
                    }
                    else
                    {
                        <option value="@eq.EquipoID">
                            @eq.NombreEquipo
                        </option>
                    }
                }
            </select>
        </div>
        <div class="col-md-2">
            <button type="submit" class="btn btn-primary">Filtrar</button>
        </div>
    </div>
</form>

<h3>Equipos Registrados</h3>
<table class="table table-striped table-bordered table-hover">
    <thead>
        <tr>
            <th>Nombre</th>
            <th>Entrenador</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var eq in pagedEquipos)
        {
            <tr>
                <td>@eq.NombreEquipo</td>
                <td>@eq.NombreEntrenador</td>
            </tr>
        }
    </tbody>
</table>

<nav aria-label="Paginación Equipos">
    <ul class="pagination">
        <li class="page-item @(page == 1 ? "disabled" : "")">
            <a class="page-link" href="?page=@(page-1)&equipoId=@selectedEquipo">Anterior</a>
        </li>
        @for (int i = 1; i <= totalPages; i++)
        {
            <li class="page-item @(i == page ? "active" : "")">
                <a class="page-link" href="?page=@i&equipoId=@selectedEquipo">@i</a>
            </li>
        }
        <li class="page-item @(page == totalPages ? "disabled" : "")">
            <a class="page-link" href="?page=@(page+1)&equipoId=@selectedEquipo">Siguiente</a>
        </li>
    </ul>
</nav>

<h3 class="mt-5">Jugadores</h3>
<table class="table table-sm table-bordered">
    <thead>
        <tr>
            <th>Nombre</th>
            <th>Edad</th>
            <th>Posición</th>
            <th>N° Camiseta</th>
            <th>Equipo</th>
            <th>Activo</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var jug in pagedJugadores)
        {
            <tr>
                <td>@jug.NombreCompleto</td>
                <td>@jug.Edad</td>
                <td>@jug.Posicion</td>
                <td>@jug.NumeroCamiseta</td>
                <td>@Model.AllEquipos.FirstOrDefault(x => x.EquipoID == jug.EquipoID)?.NombreEquipo</td>
                <td>
                    @if (jug.Estado)
                    {
                        <span class="badge bg-success">Activo</span>
                    }
                    else
                    {
                        <span class="badge bg-secondary">Inactivo</span>
                    }
                </td>
            </tr>
        }
    </tbody>
</table>

<nav aria-label="Paginación Jugadores">
    <ul class="pagination">
        <li class="page-item @(jugPage == 1 ? "disabled" : "")">
            <a class="page-link"
               href="@Url.Action(
             "Index",
             "Home",
             new {
               page      = page - 1,
               equipoId  = selectedEquipo,
               jugPage   = jugPage - 1
             })">
                Anterior
            </a>
        </li>

        @for (int j = 1; j <= totalJugPages; j++)
        {
            <li class="page-item @(j == jugPage ? "active" : "")">
                <a class="page-link"
                   href="@Url.Action(
               "Index",
               "Home",
               new {
                 page      = page,
                 equipoId  = selectedEquipo,
                 jugPage   = j
               })">
                    @j
                </a>
            </li>
        }

        <li class="page-item @(jugPage == totalJugPages ? "disabled" : "")">
            <a class="page-link"
               href="@Url.Action(
             "Index",
             "Home",
             new {
               page      = page + 1,
               equipoId  = selectedEquipo,
               jugPage   = jugPage + 1
             })">
                Siguiente
            </a>
        </li>
    </ul>
</nav>

<h3 class="mt-5">Partidos</h3>
<table class="table table-bordered">
    <thead>
        <tr>
            <th>Fecha/Hora</th>
            <th>Local</th>
            <th>Visitante</th>
            <th>Puntuación</th>
            <th>Estado</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var partido in pagedPartidos)
        {
            <tr>
                <td>@partido.FechaHora.ToString("dd/MM/yyyy HH:mm")</td>
                <td>@Model.AllEquipos.FirstOrDefault(x => x.EquipoID == partido.EquipoLocalID)?.NombreEquipo</td>
                <td>@Model.AllEquipos.FirstOrDefault(x => x.EquipoID == partido.EquipoVisitanteID)?.NombreEquipo</td>
                <td>
                    @if (partido.PuntuacionLocal != null && partido.PuntuacionVisitante != null)
                    {
                        @($"{partido.PuntuacionLocal} - {partido.PuntuacionVisitante}")
                    }
                    else
                    {
                        <span class="text-muted">Pendiente</span>
                    }
                </td>
                <td>@partido.Estado</td>
            </tr>
        }
    </tbody>
</table>

<nav aria-label="Paginación Partidos">
    <ul class="pagination">
        <li class="page-item @(partidoPage == 1 ? "disabled" : "")">
            <a class="page-link"
               href="@Url.Action("Index", "Home", new {
                   page        = page,
                   equipoId    = selectedEquipo,
                   jugPage     = jugPage,
                   partidoPage = partidoPage - 1
               })">
                Anterior
            </a>
        </li>

        @for (int m = 1; m <= totalPartPages; m++)
        {
            <li class="page-item @(m == partidoPage ? "active" : "")">
                <a class="page-link"
                   href="@Url.Action("Index", "Home", new {
                       page        = page,
                       equipoId    = selectedEquipo,
                       jugPage     = jugPage,
                       partidoPage = m
                   })">
                    @m
                </a>
            </li>
        }

        <li class="page-item @(partidoPage == totalPartPages ? "disabled" : "")">
            <a class="page-link"
               href="@Url.Action("Index", "Home", new {
                   page        = page,
                   equipoId    = selectedEquipo,
                   jugPage     = jugPage,
                   partidoPage = partidoPage + 1
               })">
                Siguiente
            </a>
        </li>
    </ul>
</nav>

<h3 class="mt-5">Estadísticas por Equipo</h3>
<table class="table table-striped table-bordered table-hover">
    <thead>
        <tr>
            <th>Equipo</th>
            <th>Jugados</th>
            <th>Ganados</th>
            <th>Perdidos</th>
            <th>Puntos a Favor</th>
            <th>Puntos en Contra</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var est in pagedStats)
        {
            <tr>
                <td>@Model.AllEquipos.First(e => e.EquipoID == est.EquipoID).NombreEquipo</td>
                <td>@est.PartidosJugados</td>
                <td>@est.Ganados</td>
                <td>@est.Perdidos</td>
                <td>@est.PuntosFavor</td>
                <td>@est.PuntosContra</td>
            </tr>
        }
    </tbody>
</table>

<nav aria-label="Paginación Estadísticas">
    <ul class="pagination">
        <li class="page-item @(statsPage == 1 ? "disabled" : "")">
            <a class="page-link"
               href="@Url.Action("Index", "Home", new {
                   page        = page,
                   equipoId    = selectedEquipo,
                   jugPage     = jugPage,
                   partidoPage = partidoPage,
                   statsPage   = statsPage - 1
               })">
                Anterior
            </a>
        </li>
        @for (int s = 1; s <= totalStatsPages; s++)
        {
            <li class="page-item @(s == statsPage ? "active" : "")">
                <a class="page-link"
                   href="@Url.Action("Index", "Home", new {
                       page        = page,
                       equipoId    = selectedEquipo,
                       jugPage     = jugPage,
                       partidoPage = partidoPage,
                       statsPage   = s
                   })">
                    @s
                </a>
            </li>
        }
        <li class="page-item @(statsPage == totalStatsPages ? "disabled" : "")">
            <a class="page-link"
               href="@Url.Action("Index", "Home", new {
                   page        = page,
                   equipoId    = selectedEquipo,
                   jugPage     = jugPage,
                   partidoPage = partidoPage,
                   statsPage   = statsPage + 1
               })">
                Siguiente
            </a>
        </li>
    </ul>
</nav>
